document.addEventListener("DOMContentLoaded",(()=>{const firstPaymentPercent=.4,maxFirstPaymentPercent=.49,minFirstPaymentPercent=.1;const form=document.querySelector(".js-calc-form");const priceField=form.querySelector('[data-field="price"]');const firstPaymentField=form.querySelector('[data-field="first-payment"]');const brandField=form.querySelector('[data-select="carBrand"]');const modelField=form.querySelector('[data-select="carModel"]');const equipmentField=form.querySelector('[data-select="carEquipment"]');const loanTermField=form.querySelector('[data-select="carLoanTerm"]');if(window.outerWidth>576){document.querySelectorAll("[data-select]").forEach((function(element){const searchable=Boolean(element.dataset.selectSearch)===true;element.select=initSelect(element,searchable);if(element.disabled===true){element.select.disable()}}))}else{modelField.querySelector('[data-display="Select"]').textContent="Выберите модель";modelField.querySelector('[data-display="Select"]').disabled=true;equipmentField.querySelector('[data-display="Select"]').textContent="Выберите комплектацию";equipmentField.querySelector('[data-display="Select"]').disabled=true}const equipmentSelect=equipmentField.select,loanTermSelect=loanTermField.select;if(loanTermSelect===undefined)loanTermField.querySelector("option[data-display]").remove();const setMonthlyPrice=function(firstPaymentReload=true){let price;if(equipmentSelect!==undefined){if(equipmentSelect.selectedOptions.length>0){price=Number(equipmentSelect.selectedOptions[0].data.value.split(",")[1].trim())}else{price=0}}else{price=equipmentField.value.split(",")[1].trim()}let firstPayment;let loanTerm;loanTermSelect!==undefined?loanTerm=loanTermSelect.selectedOptions[0].data.value:loanTerm=loanTermField.value;if(firstPaymentReload){firstPayment=Math.floor(price*firstPaymentPercent);firstPaymentField.dataset.value=`${firstPayment}`;firstPaymentField.dataset.min=`${price*minFirstPaymentPercent}`;firstPaymentField.dataset.max=`${price*maxFirstPaymentPercent}`;firstPaymentField.value=`${window.formatPrice(firstPayment)} ₽`;firstPaymentField.disabled=false;loanTermField.disabled=false;if(loanTermSelect!==undefined)loanTermSelect.enable();priceField.value=price}else{firstPayment=firstPaymentField.dataset.value}};if(brandField){const brandSelect=brandField.select;brandField.addEventListener("change",(function(){const niceSelectOptions=brandSelect.selectedOptions,markId=brandField.querySelector(`option[value="${niceSelectOptions[0].data.value}"]`).dataset.id;const body=new FormData;body.append("action","getModels");body.append("mark",markId);window.fetchRequest(location.pathname,{method:"post",body:body,headers:new Headers({"X-Requested-With":"XMLHttpRequest"}),credentials:"same-origin"}).then((response=>response.json())).then((res=>{if(res.length>0){equipmentField.disabled=true;equipmentSelect.clear();equipmentSelect.disable();firstPaymentField.value="0 ₽";firstPaymentField.disabled=true;loanTermSelect!==undefined?loanTermSelect.disable():loanTermField.disabled=true;priceField.value=0;modelField.innerHTML="";const optionAny=document.createElement("option");optionAny.dataset.display="Select";optionAny.textContent="";modelField.append(optionAny);new Promise((function(resolve){res.forEach((item=>{const option=document.createElement("option");option.textContent=item["NAME"];option.value=item["NAME"];option.dataset.id=item["ID"];modelField.append(option)}));return resolve(true)})).then((result=>{if(result){const modelSelect=modelField.select;modelField.disabled=false;modelSelect.update();modelSelect.enable()}}))}else{showNotify("Упс...","По вашему запросу ничего не найдено","danger")}}))}))}if(modelField){const modelSelect=modelField.select;modelField.addEventListener("change",(function(){let modelId;if(typeof modelSelect!=="undefined"){modelId=modelField.querySelector(`option[value="${modelSelect.selectedOptions[0].data.value}"]`).dataset.id}else{modelId=modelField[modelField.selectedIndex].dataset.id}const body=new FormData;body.append("action","getComplect");body.append("model",modelId);window.fetchRequest(location.pathname,{method:"post",body:body,headers:new Headers({"X-Requested-With":"XMLHttpRequest"}),credentials:"same-origin"}).then((response=>response.json())).then((res=>{if(res.length>0){firstPaymentField.value="0 ₽";firstPaymentField.disabled=true;if(loanTermSelect!==undefined){loanTermSelect.disable()}else{loanTermField.querySelector("option[value='84']").selected=true;loanTermField.disabled=true}priceField.value=0;equipmentField.innerHTML="";if(equipmentSelect!==undefined){const optionAny=document.createElement("option");optionAny.dataset.display="Select";optionAny.textContent="";equipmentField.append(optionAny)}else{const option=document.createElement("option");option.selected="selected";option.disabled="disabled";option.textContent="Выберите комплектацию";equipmentField.append(option)}new Promise((function(resolve){res.forEach((item=>{const option=document.createElement("option");option.textContent=`${item["NAME"]}, ${window.formatPrice(Number(item["PRICE"]))} ₽`;option.value=`${item["NAME"]}, ${item["PRICE"]}`;equipmentField.append(option)}));return resolve(true)})).then((result=>{if(result){equipmentField.disabled=false;if(equipmentSelect!==undefined){equipmentSelect.update();equipmentSelect.enable()}}}))}else{showNotify("Упс...","По вашему запросу ничего не найдено","danger")}}))}))}if(equipmentField){equipmentField.addEventListener("change",(()=>setMonthlyPrice()))}if(loanTermField){loanTermField.addEventListener("change",(()=>setMonthlyPrice(false)))}if(firstPaymentField){firstPaymentField.addEventListener("focus",(function(){this.setAttribute("type","number");this.value=Number(this.dataset.value)}));firstPaymentField.addEventListener("change",(function(){if(Number(this.value)>Number(this.dataset.max)){this.value=Number(this.dataset.max)}else if(Number(this.value)<Number(this.dataset.min)){this.value=Number(this.dataset.min)}this.dataset.value=this.value;setMonthlyPrice(false)}));firstPaymentField.addEventListener("blur",(function(){this.setAttribute("type","text");this.value=`${window.formatPrice(Number(this.dataset.value))} ₽`}));firstPaymentField.addEventListener("keydown",(function(e){if(e.key==="Enter"){e.preventDefault();window.triggerEvent(this,"change");window.triggerEvent(this,"blur")}}))}const anchorCreditBtn=document.querySelectorAll(".js-anchor-credit");if(anchorCreditBtn.length>0){anchorCreditBtn.forEach((el=>{el.addEventListener("click",(function(e){e.preventDefault();const blockID=this.getAttribute("href").substr(1);document.getElementById(blockID).scrollIntoView({behavior:"smooth",block:"start"});new Promise((resolve=>{const modelId=this.dataset.model;const modelName=this.dataset.modelName;if(modelId){equipmentField.innerHTML="";if(equipmentSelect!==undefined){const optionAny=document.createElement("option");optionAny.dataset.display="Select";optionAny.textContent="";equipmentField.append(optionAny)}if(modelField.querySelector("option[selected]")!==null){modelField.querySelector("option[selected]").removeAttribute("selected")}modelField.querySelector(`option[data-id="${modelId}"]`).setAttribute("selected",true);modelField.value=modelField.querySelector(`option[data-id="${modelId}"]`).value;if(modelField.select!==undefined)modelField.select.update();window.triggerEvent(modelField,"change");return resolve(true)}})).then((result=>{if(result){const equipmentName=this.dataset.equipment;new Promise((resolve=>{const equipmentReady=setInterval((()=>{if(equipmentField.querySelector(`option[value*="${equipmentName}"]`)!==null){clearInterval(equipmentReady);return resolve(equipmentField.querySelector(`option[value*="${equipmentName}"]`))}}),10)})).then((result=>{result.setAttribute("selected","selected");equipmentField.value=result.value;if(equipmentSelect!==undefined)equipmentField.select.update();return window.triggerEvent(equipmentField,"change")}))}}))}))}))}}));